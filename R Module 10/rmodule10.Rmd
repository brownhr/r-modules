---
title: "R Module 10"
author: "Harrison Brown"
date: "`r format(Sys.Date() - 1, '%B %d, %Y')`"
output:
  pdf_document: default
  html_document:
    css: ~/html_air_square/resources/air_square.css
    fig_caption: yes
---

```{=html}
<style>
body {
text-align: justify}
</style>
```
```{r setup, include=FALSE}
rm(list = ls())
setwd("C:/Users/brownhr/Documents/R Projects/R Module 10")

library(sf)
library(stats)
library(dplyr)
library(ggplot2)
library(spdep)
library(spatialreg)

election_sf <- st_read("data/election_sf.shp")
W_cont_el_mat.sf <- st_read("data/W_cont_el_mat_sf.shp")
W_cont_el <- readRDS("data/W_cont_el.RDS")
W_cont_el_mat <- readRDS("data/W_cont_el_mat.RDS")
election_spatialreg <- readRDS("data/spatialmodel.RDS")
spatialerror <- readRDS("data/spatialerror.RDS")
knitr::opts_chunk$set(echo = TRUE)
```

# Spatial Regression

## Queen's Rule Neighbors

Using `poly2nb` from the `spdep` package gives the following results

```{r eval=FALSE, include=TRUE}
neighbors <- poly2nb(election_sf, queen = T)
```

```{r neighbors, echo=F, fig.cap="Queen's Method neighbors"}
neighbors <- ggplot() +
  geom_sf(data = election_sf,
          fill = "transparent",
          color = "gray75",
          lwd = .2) + 
  geom_sf(data = W_cont_el_mat.sf,
          color = "gray25",
          lwd = .05) +
  theme(
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank()
  )
neighbors
```

\pagebreak

## 1. Residuals

Plotting the residuals of `Bush_pct ~ pcincome` from the results of the election gives the following results:

```{r olsggplot, echo = F, fig.cap="Residuals of Bush_pct ~ pcincome"}
ggplot(election_sf, aes(fill = residls)) + 
  geom_sf(color = "transparent", lwd = 0) + 
  scale_fill_steps2(low = "darkgreen",
                    mid = "grey95",
                    high = "darkblue",
                    breaks = c(
                      -Inf, -50, -30, -10, 10, 30, Inf
                    ),
                    # n.breaks = 7,
                    # nice.breaks = F,
                    labels = function(x)round(x,1)) + 
  labs(fill = "Residuals") + 
  theme(
    panel.background = element_blank()
  )
```

The results of this plot of residuals appear to correlate with an urban/rural split, with rural, traditionally Republican counties (e.g., Midwest) showing higher residuals, and urban, traditionally Democrat areas (e.g., New England) showing lower residuals.

\pagebreak

## 2. Spatial Lag Model

Spatial lag is a spatial regression model that accounts for autocorrelation among neighbors, defined by the function $\gamma = \rho W \gamma + \beta x + \epsilon$, with the coefficient rho ($\rho$) representing spatial autocorrelation between neighbors.

Using the formula for spatial lag from `spatialreg::lagsarlm()`, the residuals for the same analysis are as follows:

```{r lagsarlm, echo = F, fig.cap="Residuals of Spatial Lag model"}
ggplot(election_sf, aes(fill = rsdls_l)) + 
  geom_sf(color = "transparent", lwd = 0) + 
  scale_fill_steps2(low = "darkgreen",
                    mid = "grey95",
                    high = "darkblue",
                    breaks = c(
                      -Inf, -50, -30, -10, 10, 30, Inf
                    ),
                    # n.breaks = 7,
                    # nice.breaks = F,
                    labels = function(x)round(x,1)) + 
  labs(fill = "Residuals") + 
  theme(
    panel.background = element_blank()
  )

```

### 3. Moran's I

```{r spatialLagMoran, include = TRUE}
moran.spatiallag <- 
  moran.test(x = election_sf$rsdls_l, 
             listw = W_cont_el_mat, 
             zero.policy = TRUE,
             alternative = "two.sided")
```

Additionally, calculating Moran's I on the residuals of the Spatial Lag model gives a p-value of **`r moran.spatiallag$p.value`** and a Moran's I statistic of **`r unname(moran.spatiallag$estimate[1])`**, indicating that when adjusting for spatial lag, the remaining factors caused by spatial autocorrelation are largely removed. The value of the coefficient for spatial autocorrelation among neighbors, $\rho$, for the spatial lag model is **`r election_spatialreg$rho`**, indicating a strong positive spatial autocorrelation.

\pagebreak

## 4. Spatial Error


The function for spatial error, $\gamma = \beta x + \epsilon; \epsilon = \lambda W \epsilon+\zeta$, represents spatial autocorrelation separated into two terms, with $\lambda$ representing the correlation coefficient, and $\zeta$ modelling random error.

Estimating the same function when modeling spatial error (with the `spatialreg::errorsarlm()` function), the results are as follows:

```{r spatialerror, echo = F, fig.cap="Residuals of Spatial Error model"}
ggplot(election_sf, aes(fill = rsdls_e)) + 
  geom_sf(color = "transparent", lwd = 0) + 
  scale_fill_steps2(low = "darkgreen",
                    mid = "grey95",
                    high = "darkblue",
                    breaks = c(
                      -Inf, -50, -30, -10, 10, 30, Inf
                    ),
                    # n.breaks = 7,
                    # nice.breaks = F,
                    labels = function(x)round(x,1)) + 
  labs(fill = "Residuals") + 
  theme(
    panel.background = element_blank()
  )
```

### Moran's I

```{r moran-spatialerror}
moran.spatialerror <- 
  moran.test(x = election_sf$rsdls_e,
             listw = W_cont_el_mat,
             zero.policy = TRUE,
             alternative = "two.sided")
```

The residuals from the spatial error model are quite similar to the spatial lag model, with a Moran's I statistic of **`r unname(moran.spatialerror$estimate[1])`** and a p-value of **`r moran.spatialerror$p.value`**. With the Moran's I statistic being close to 0, there is little spatial autocorrelation when accounting for spatial error. As with the spatial lag model, this indicates that the original factors of the data are highly spatially autocorrelated, with a value of $\lambda$=**`r spatialerror$lambda`**.

### Summary

The summary from the analysis of spatial regression indicates that there is a strong spatial effect on the relationship between per-capita income and percentage of population who voted for Bush within U.S. counties. In addition to per capita income, other variables to consider could include demographic makeup, rural/urban percent, and unemployment rates.
